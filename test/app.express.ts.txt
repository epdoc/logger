import * as express from 'express';
import { request } from 'http';
import { LogMgr, Logger, express as e } from '../src';

describe('Express response middleware', function () {
  this.timeout(300000);

  let app = express.application;
  let middleware = new e.Middleware() as e.Middleware;

  beforeEach((done) => {
    const logMgr = new LogMgr();
    middleware.setLogMgr(logMgr);
    logMgr.start().then(() => {
      let log: Logger = logMgr.getLogger('app');
      log.info('Adding middleware');
      app.use(middleware.getReqIdFn());
      //app.use(app.router);
      app.all('*', middleware.getRequestLoggerFn());
      app.all('*', middleware.getRouteSeparatorFn());
      app.all('*', middleware.getRouteLoggerFn());

      app.get('/a', (req, res) => {
        const log = req.log as Logger;
        log.pushName('a').resetElapsed();
        setTimeout(() => {
          log.info('Timer should be about 500').elapsed('a').emit();
          res.send({ message: 'hello world' });
        }, 500);
      });
      app.get('/b', (req, res) => {
        res.json({ message: 'hello world' });
      });
      app.get('/c', (req, res) => {
        log.pushName('c').resetElapsed('c');
        setTimeout(function () {
          log.info('Timer should be about 250').elapsed('c').emit();
          res.end('hello world');
        }, 250);
      });

      app.listen(3000);
      done();
    }, done);
  });

  it('send', (done) => {
    request(app)
      .get('/a')
      .expect(200)
      .end(function (err, res) {
        if (err) {
          done(err);
        } else {
          expect(res).toHaveProperty('body');
          expect(res.body).toHaveProperty('message', 'hello world');
          done();
        }
      });
  });

  it('json', (done) => {
    request(app)
      .get('/b')
      .expect(200)
      .end(function (err, res) {
        if (err) {
          done(err);
        } else {
          expect(res).toHaveProperty('body');
          expect(res.body).toHaveProperty('message', 'hello world');
          done();
        }
      });
  });

  it('end', (done) => {
    request(app)
      .get('/c')
      .expect(200)
      .end(function (err, res) {
        if (err) {
          done(err);
        } else {
          expect(res).toHaveProperty('text', 'hello world');
          done();
        }
      });
  });
});
